<h1>ユーザー管理</h1>

<%= link_to "フォロー関係管理", admin_connections_index_path, class: "btn btn-outline-primary" %>


<form action="<%= search_admin_users_path %>" method="get" class="d-flex mb-3">
  <input type="text" name="query" class="form-control" placeholder="ユーザー名で検索">
  <button type="submit" class="btn btn-primary ms-2">検索</button>
</form>

<table class="table table-striped">
  <thead>
    <tr>
      <th>プロフィール</th>
      <th>名前</th>
      <th>メールアドレス</th>
      <th>ステータス</th>
      <th>アクション</th>
    </tr>
  </thead>
  <tbody>
  <% if @users.present? %>
    <% @users.each do |user| %>
      <tr>
        <td>
          <% if user.profile_image.attached? %>
            <%= image_tag user.profile_image.variant(resize_to_limit: [50, 50]), class: "rounded-circle" %>
          <% else %>
            <%= image_tag "no_image.jpg", class: "rounded-circle mb-3", width: 50, height: 50 %>
          <% end %>
        </td>
        <td><%= user.name %></td>
        <td><%= user.email %></td>
        <td>
        <% if user.status_before_type_cast == 0 %>
          アクティブ
        <% else %>
          退会済み
        <% end %>
        </td>
        <td class="d-flex gap-2">
          <%= link_to "詳細", admin_user_path(user), class: "btn btn-primary btn-sm flex-fill" %>
          <% if user.status == "active" %>
            <%= link_to "削除", admin_user_path(user), method: :delete, class: "btn btn-danger btn-sm flex-fill", data: { confirm: "本当に削除しますか？" } %>
          <% end %>
          <%= link_to(user.status == "active" ? "⛔ 無効化" : "✅ 有効化",
            toggle_status_admin_user_path(user),  # ✅ 正しいルート名に修正！
            method: :patch,
            class: user.status == "active" ? "btn btn-warning btn-sm flex-fill" : "btn btn-success btn-sm flex-fill",
            data: { confirm: "#{user.name} のアカウントを#{user.status == 'active' ? '無効化' : '有効化'}しますか？" }) %>
        </td>
      </tr>
    <% end %>
  <% else %>
    <tr>
      <td colspan="5">ユーザーが存在しません</td> <!-- colspanを調整 -->
    </tr>
  <% end %>
</tbody>
</table>

<div class="actions mt-3">
  <%= link_to "ダッシュボードへ戻る", admin_dashboard_path, class: "btn btn-outline-secondary" %>
</div>

<div class="sorting-options mb-3">
  <%= link_to "新しい順", admin_users_path(sort: "newest"), class: "btn btn-outline-primary" %>
  <%= link_to "古い順", admin_users_path(sort: "oldest"), class: "btn btn-outline-primary" %>
  <%= link_to "アクティブユーザーのみ", admin_users_path(filter: "active"), class: "btn btn-outline-success" %>
</div>
