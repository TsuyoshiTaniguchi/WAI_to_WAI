<!-- app/views/public/daily_reports/_performance_chart.html.erb -->
<div class="mb-4">
  <h3>パフォーマンスの推移</h3>
  <div style="width:400px; height:300px; margin:0 auto;">
    <canvas id="performanceChart" style="width:100%; height:100%;"></canvas>
  </div>
</div>

<!-- 他のグラフの HTML（growthChart, futureGrowthChart など）もそのままで大丈夫です -->

<script>
document.addEventListener("turbolinks:load", function() {
  let ctx = document.getElementById('performanceChart');
  if (!ctx) return;
  
  // キャンバスに既に関連付けられている Chart インスタンスがあれば破棄する
  let existingChart = Chart.getChart(ctx);
  if (existingChart) {
    existingChart.destroy();
  }
  
  fetch('/daily_reports/performance_data.json')
    .then(res => res.json())
    .then(data => {
      window.performanceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.dates,
          datasets: [
            {
              label: 'タスク達成度',
              data: data.task_achievements,
              borderColor: 'rgba(75,192,192,1)',
              backgroundColor: 'rgba(75,192,192,0.2)',
              tension: 0.4,
              fill: true
            },
            {
              label: '自己評価',
              data: data.self_evaluations,
              borderColor: 'rgba(153,102,255,1)',
              backgroundColor: 'rgba(153,102,255,0.2)',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: { mode: 'index', intersect: false }
          },
          interaction: { mode: 'nearest', intersect: false },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    })
    .catch(err => console.error('パフォーマンスデータ取得エラー:', err));
});
</script>