<!-- app/views/daily_reports/index.html.erb -->

<h1 class="mb-4">ライフログ＜日報一覧＞</h1>

<!-- 新規日報作成ボタン -->
<div class="d-flex justify-content-end mb-3">
  <%= link_to "新規日報作成", new_daily_report_path, class: "btn btn-primary px-4" %>
</div>

<!-- 説明エリア：グラフと指標の説明 -->
<div class="alert alert-info mb-4">
  <h4>グラフと指標の説明</h4>
  <ul>
    <li><strong>目標値:</strong> 将来に向けた目標の数値。ここに設定した値が指標となり、達成率のベースになります。</li>
    <li><strong>達成率:</strong> 現在のタスク達成度が目標値に対してどれだけ達成されているかの割合です。</li>
    <li><strong>パフォーマンススコア:</strong> タスク達成度と自己評価の平均値で、総合的な成績を示します。</li>
  </ul>
</div>



<!-- 上段：カレンダー＆パフォーマンス、位置情報 -->
<div class="row mb-4">
  <!-- 左カラム：カレンダーとパフォーマンス推移グラフ -->
  <div class="col-md-6">
    <!-- カレンダー用カード -->
    <div class="card mb-3">
      <div class="card-header">
        <h3 class="mb-0">カレンダー</h3>
      </div>
      <div class="card-body">
        <div id="calendar" style="height:300px;"></div>
      </div>
    </div>

    <!-- パフォーマンス推移グラフ用カード -->
    <div class="card mb-3">
      <div class="card-header">
        <h3 class="mb-0">パフォーマンスの推移</h3>
      </div>
      <div class="card-body">
        <%= render 'performance_chart' %>
      </div>
    </div>
  </div>
  
  <!-- 右カラム：地図 -->
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h3 class="mb-0">位置情報</h3>
      </div>
      <div class="card-body">
         <div id="map" style="width:100%; height:400px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- フィルタリングフォーム -->
<div class="card mb-4">
  <div class="card-header">
    <h3 class="mb-0">検索フィルター</h3>
  </div>
  <div class="card-body">
    <form action="<%= daily_reports_path %>" method="get">
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="date_range" class="form-label">期間で検索:</label>
          <select name="date_range" id="date_range" class="form-select">
            <option value="7"  <%= 'selected' if params[:date_range]=='7'  %>>過去7日間</option>
            <option value="30" <%= 'selected' if params[:date_range]=='30' %>>過去30日間</option>
            <option value="90" <%= 'selected' if params[:date_range]=='90' %>>過去3ヶ月</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="keyword" class="form-label">キーワード検索:</label>
          <%= text_field_tag :keyword, params[:keyword], id: "keyword", class: "form-control", placeholder: "キーワード入力" %>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">検索</button>
    </form>
  </div>
</div>

<!-- タイムライン：日報履歴 -->
<div class="card mb-4">
  <div class="card-header">
    <h3 class="mb-0">日報履歴（タイムライン）</h3>
  </div>
  <div class="card-body">
    <div class="timeline">
      <% if @daily_reports.any? %>
        <% @daily_reports.each do |report| %>
          <div class="timeline-item mb-3">
            <div class="timeline-icon text-primary"><i class="fas fa-file-alt"></i></div>
            <div class="timeline-content">
              <h5>
                <%= report.date.strftime("%Y年%m月%d日") %>
                <% badge = report.public_report? ? '公開' : '非公開' %>
                <span class="badge <%= report.public_report? ? 'bg-success' : 'bg-secondary' %>">
                  <%= badge %>
                </span>
              </h5>
              <p><strong>場所:</strong> <%= report.location %></p>
              <p><%= truncate(report.content, length: 100) %></p>
              <div class="d-flex">
                <%= link_to "詳細を見る", daily_report_path(report), class: "btn btn-sm btn-outline-primary me-2" %>
                <% if report.user == current_user %>
                  <%= link_to "編集", edit_daily_report_path(report), class: "btn btn-warning btn-sm me-2" %>
                  <%= link_to "削除", report, method: :delete, data: { confirm: "本当に削除しますか？" }, class: "btn btn-danger btn-sm" %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      <% else %>
        <p class="text-center text-muted">まだ日報がありません。新規作成してください。</p>
      <% end %>
    </div>
  </div>
</div>

<!-- フッターリンク：マイページへ -->
<div class="text-center mt-4">
  <%= link_to "マイページに戻る", users_mypage_path, class: "btn btn-outline-secondary btn-lg px-4" %>
</div>