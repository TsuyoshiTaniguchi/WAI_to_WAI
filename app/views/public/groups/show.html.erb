<% if @group.group_image&.attached? %>
  <%= image_tag @group.group_image.variant(resize_to_fill: [200, 200]) if @group.group_image&.attached? %>
<% else %>
  <%= image_tag "no_image.jpg", class: "group-image mb-3", width: 200, height: 200 %>
<% end %>

<h1><%= @group.name %></h1>
<p><%= @group.description %></p>

<% if @group.official_label? %>
  <p class="badge bg-warning text-dark">公式プロジェクト</p>
<% else %>
  <p class="badge bg-info text-white">ユーザー作成グループ</p>
<% end %>

<p>オーナー: <%= @group.owner&.name || "未設定" %></p>

<% if @group.owner == current_user %>
  <%= link_to "グループを編集", edit_user_group_path(current_user, @group), class: "btn btn-warning" %>
<% end %>

<h3>メンバー一覧</h3>
<% if @group.users.any? %>
  <ul>
    <% @group.users.each do |user| %>
      <li><%= link_to user.name, user_path(user) %></li>
    <% end %>
  </ul>
<% else %>
  <p>まだメンバーがいません。</p>
<% end %>

<% if @group.users.include?(current_user) %>
  <%= button_to "グループを脱退", leave_group_path(@group), method: :delete, class: "btn btn-danger mt-3" %>
<% else %>
  <%= button_to "このグループに参加する", group_memberships_path(@group), method: :post, class: "btn btn-primary mt-3" %>
<% end %>

<h3>最近のアクティビティ</h3>
<% recent_posts = @group.posts.order(created_at: :desc).limit(5) %>
<% new_members = @group.users.order(created_at: :desc).limit(3) %>

<% if recent_posts.any? || new_members.any? %>
  <% recent_posts.each do |post| %>
    <p>📝 <%= link_to post.title, group_post_path(@group, post) %>（<%= post.created_at.strftime("%Y-%m-%d") %>）</p>
  <% end %>

  <% new_members.each do |member| %>
    <p>👤 <%= link_to member.name, user_path(member) %> がメンバーになりました！（<%= member.created_at.strftime("%Y-%m-%d") %>）</p>
  <% end %>
  
<% else %>  # ✅ 正しく `if` のブロックの最後に `else` を配置！
  <p>まだ新しい活動はありません。</p>
<% end %>


<h3>このグループの投稿</h3>
<% if @group.posts.any? %>
  <ul>
    <% @group.posts.order(created_at: :desc).each do |post| %>
      <li>
        📝 <%= link_to post.title, group_post_path(@group, post) %>（<%= post.created_at.strftime("%Y-%m-%d") %>）
      </li>
    <% end %>
  </ul>
<% else %>
  <p>まだ投稿がありません。</p>
<% end %>

<% if @group.users.include?(current_user) %>
  <%= link_to "新規投稿", new_group_post_path(@group), class: "btn btn-primary mt-3" %>
<% end %>

<% if @user.present? %>
  <%= link_to "グループ一覧へ戻る", user_groups_path(@user), class: "btn btn-secondary" %>
<% else %>
  <%= link_to "グループ一覧へ戻る", user_groups_path(current_user), class: "btn btn-secondary" %>
<% end %>