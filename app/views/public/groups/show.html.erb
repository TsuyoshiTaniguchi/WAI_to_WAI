<% if @group.group_image&.attached? %>
  <!-- グループ画像の表示 -->
  <%= image_tag @group.group_image.variant(resize_to_fill: [200, 200]) %>
<% else %>
  <%= image_tag "no_image.jpg", class: "group-image mb-3", width: 200, height: 200 %>
<% end %>

<!-- グループ情報 -->
<h1><%= @group.name %></h1>

<!-- グループの説明 -->
<h3>グループ情報</h3>
<% if @group.description.present? %>
  <p><%= @group.description %></p>
<% else %>
  <p class="text-muted">このグループにはまだ説明がありません。</p>
<% end %>

<!-- グループの種別（公式 or ユーザー作成） -->
<% if @group.official_label? %>
  <p class="badge bg-warning text-dark">公式プロジェクト</p>
<% else %>
  <p class="badge bg-info text-white">ユーザー作成グループ</p>
<% end %>

<!-- グループの所有者 -->
<p>オーナー: <%= @group.owner&.name || "未設定" %></p>


<% if current_user == @group.owner %>
  <p class="text-muted">このページでは、グループ全体の管理を行えます。</p>
  <%= link_to "⚡ オーナー管理ページ", owner_dashboard_group_membership_path(@group), class: "btn btn-primary mt-3" %>
<% end %>

<% if current_user == @group.owner %>
  <div class="mt-3">
    <%= link_to "🛠 参加リクエスト管理へ", manage_group_group_membership_path(@group), class: "btn btn-warning" %>
  </div>
<% end %>

<!-- プライバシー設定の表示 -->
<p> 投稿の共有範囲: 
  <% case @group.privacy %>
    <% when "public_visibility" %>
      <span class="badge bg-success">公開</span>
    <% when "restricted_visibility" %>
      <span class="badge bg-warning">メンバーのみ公開</span>
    <% when "private_visibility" %>
      <span class="badge bg-danger">非公開</span>
    <% else %>
      <span class="badge bg-secondary">未設定</span>
  <% end %>
</p>

<!-- グループの所有者が自分でない、かつゲストではない場合に表示 -->
<% unless current_user.guest? || current_user == @group.owner %>
  <% if @group.reported? %>
    <p class="text-danger fw-bold">⚠️ このグループは通報済みです。</p>
  <% else %>
    <%= link_to "⚠️ このグループを通報", report_group_path(@group),
                method: :patch,
                class: "btn btn-danger btn-sm",
                data: { confirm: "本当にこのグループを通報しますか？" } %>
  <% end %>
<% end %>

<h3>参加ルール</h3>
<% case @group.join_policy %>
  <% when "open" %>
    <p class="text-success">誰でも自由に参加できます。</p>
  <% when "admin_approval" %>
    <p class="text-warning">管理者の承認が必要です。</p>
  <% when "invite_only" %>
    <p class="text-danger">招待制のグループです。</p>
  <% else %>
    <p class="text-muted">参加ルールが設定されていません。</p>
  <% end %>


<% non_admin_memberships = @group.memberships.where(role: "member") %>

<h3>メンバー一覧 (<%= non_admin_memberships.count %>人)</h3>

<% if non_admin_memberships.any? %>
  <ul class="list-group">
    <% non_admin_memberships.limit(10).each do |membership| %>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <%= link_to membership.user.name, user_path(membership.user) %>
        <% unless current_user.guest? %>
          <% if membership.user.reported? %>
            <span class="text-danger fw-bold">⚠️ 通報済み</span>
          <% else %>
            <%= link_to "⚠️ メンバーを通報する", user_path(membership.user), class: "text-danger" %>
          <% end %>
        <% end %>
      </li>
    <% end %>
  </ul>
  <% if non_admin_memberships.count > 10 %>
    <%= link_to "すべてのメンバーを見る", group_members_path(@group), class: "btn btn-sm btn-outline-secondary mt-2" %>
  <% end %>
<% else %>
  <p>まだメンバーがいません。</p>
<% end %>

<!-- グループへの参加・脱退ボタン -->
<% if current_user.guest? %>
  <p class="text-muted">ゲストユーザーはグループに参加できません。</p>
<% elsif @group.memberships.exists?(user: current_user, role: "member") %>
  <%= link_to "グループを脱退", leave_group_path(@group), method: :delete, class: "btn btn-danger mt-3" %>
<% elsif @group.memberships.exists?(user: current_user, status: "pending") %>
  <p class="text-muted">⏳ 参加リクエスト送信済み。管理者の承認待ち！</p>
<% elsif !@group.memberships.exists?(user: current_user, status: "member") && current_user != @group.owner %>
  <% if @group.join_policy == "admin_approval" %>
    <%= button_to "🔒 参加リクエストを送る", request_join_group_path(@group), method: :post, class: "btn btn-warning mt-3" %>
  <% else %>
    <%= button_to "✅ 参加する", request_join_group_path(@group), method: :post, class: "btn btn-primary mt-3" %>
  <% end %>
<% end %>


<!-- 最近のアクティビティ（新規投稿・承認済み新しいメンバー） -->
<h3>最近のアクティビティ</h3>
<% approved_new_members = @group.memberships.where(status: "member").order(created_at: :desc).limit(3).map(&:user) %>

<% if @recent_posts.any? || approved_new_members.any? %>
  <ul class="list-unstyled">
    <% @recent_posts.each do |post| %>
      <li>
        📢 <strong>新規投稿:</strong>
        <%= link_to post.title, group_post_path(@group, post) %>
        （<%= post.created_at.strftime("%Y-%m-%d") %>）
      </li>
    <% end %>
    <% approved_new_members.each do |member| %>
      <li>
        🆕 <strong>新しいメンバー:</strong>
        <%= link_to member.name, user_path(member) %>
        （<%= member.created_at.strftime("%Y-%m-%d") %>）
      </li>
    <% end %>
  </ul>
<% else %>
  <p class="text-muted">まだ新しい活動はありません。</p>
<% end %>

<!-- 投稿一覧 -->
<h3>このグループの投稿</h3>
<% if @group.privacy == "public_visibility" || @group.users.include?(current_user) %>
  <% if @group.posts.any? %>
    <ul>
      <% @group.posts.order(created_at: :desc).each do |post| %>
        <li>
          📝 <%= link_to post.title, group_post_path(@group, post) %>（<%= post.created_at.strftime("%Y-%m-%d") %>）
        </li>
      <% end %>
    </ul>
  <% else %>
    <p>まだ投稿がありません。</p>
  <% end %>
<% else %>
  <p class="text-muted">このグループの投稿はメンバーのみ閲覧できます。</p> <!-- 非メンバーには閲覧不可メッセージを表示 -->
<% end %>

<!-- 新規投稿ボタン（参加済みのメンバーにのみ表示） -->
<% if @group.memberships.exists?(user: current_user, status: "member") %> <!-- メンバーのみ新規投稿ボタンを表示 -->
  <%= link_to "新規投稿", new_group_post_path(@group), class: "btn btn-primary mt-3" %>
<% end %>

<!-- グループ一覧に戻るボタン -->
<%= link_to "グループ一覧へ戻る", groups_path, class: "btn btn-secondary" %>