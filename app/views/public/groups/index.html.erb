<h1>グループ一覧</h1>

<!-- ✅ 検索フォーム（常に表示） -->
<div class="mb-3">
  <form action="<%= user_groups_path(@user) %>" method="get" class="d-flex">
    <input type="text" name="query" class="form-control" placeholder="グループ名で検索" value="<%= params[:query] %>">
    <button type="submit" class="btn btn-primary ms-2">検索</button>
  </form>
</div>

<!-- ✅ 検索結果を分かりやすく表示 -->
<% if @query.present? %>
  <div class="alert alert-info">
    <h2>「<%= @query %>」の検索結果</h2>
  </div>

  <% if @groups.any? %>
    <div class="row">
      <% @groups.each do |group| %>
        <div class="col-md-4">
          <div class="card p-3 mb-3">
            <!-- ✅ 追加: グループ画像の表示 -->
            <% if group.group_image.attached? %>
              <%= image_tag group.group_image.variant(resize_to_fill: [100, 100]), class: "group-image-preview mb-2" %>
            <% else %>
              <%= image_tag asset_path("no_image.jpg"), class: "group-image mb-3" %>
            <% end %>

            <h4><%= link_to group.name, user_group_path(@user, group) %></h4>
            <p>📢 <%= group.category.present? ? t("enums.group.category.#{group.category}") : "未分類" %></p>
            <p>👥 メンバー数: <%= group.memberships.count %>人</p>
            <%= link_to "詳細を見る", user_group_path(@user, group), class: "btn btn-outline-info btn-sm" %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="alert alert-warning">
      <p>該当するグループが見つかりませんでした。</p>
    </div>
  <% end %>

  <!-- ✅ 検索結果終了を明確に -->
  <hr class="my-4">
  <p class="text-center text-muted">🔍 検索結果の表示はここまでです。</p>
<% end %>

<h2>おすすめのグループ</h2>
<div class="row">
  <% Group.public_visibility.order("RANDOM()").limit(3).each do |group| %>
    <div class="col-md-4">
      <div class="card p-3 mb-3">
        <!-- ✅ 追加: グループ画像の表示 -->
        <% if group.group_image.attached? %>
          <%= image_tag group.group_image.variant(resize_to_fill: [100, 100]), class: "group-image-preview mb-2" %>
        <% else %>
          <%= image_tag "no_image.jpg", class: "group-image-preview mb-2", width: 200, height: 200 %>
        <% end %>

        <h4><%= link_to group.name, user_group_path(current_user, group) %></h4>
        <p>📢 <%= group.category.present? ? t("enums.group.category.#{group.category}") : "未分類" %></p>
        <p>👥 メンバー数: <%= group.memberships.count %>人</p>
        <%= button_to "🔒 参加リクエストを送る", request_join_group_path(group), method: :post, class: "btn btn-primary btn-sm" %>
        <%= link_to "詳細を見る", user_group_path(current_user, group), class: "btn btn-outline-info btn-sm" %>
      </div>
    </div>
  <% end %>
</div>

<h2>参加中しているグループ</h2>
<% if @user.groups.present? %>
  <% @user.groups.each do |group| %>
    <div class="card p-3 mb-3">
      <!-- ✅ 追加: グループ画像の表示 -->
      <% if group.group_image.attached? %>
        <%= image_tag group.group_image.variant(resize_to_fill: [100, 100]), class: "group-image-preview mb-2" %>
      <% else %>
        <%= image_tag "no_image.jpg", class: "group-image-preview mb-2", width: 200, height: 200 %>
      <% end %>

      <h4><%= link_to group.name, user_group_path(@user, group) %></h4>
      <p>📢 <%= group.category.present? ? t("enums.group.category.#{group.category}") : "未分類" %></p>
      <p>👥 メンバー数: <%= group.memberships.count %>人</p>

      <% if group.privacy == "restricted_visibility" %>
        <%= button_to "🔒 参加リクエストを送る", request_join_group_path(group), method: :post, class: "btn btn-primary btn-sm" %>
      <% end %>

      <%= link_to "📄 詳細を見る", user_group_path(@user, group), class: "btn btn-outline-info btn-sm" %>
    </div>
  <% end %>
<% end %>

<div class="d-flex justify-content-center gap-2 mb-3">
  <%= link_to " ホームに戻る", root_path, class: "btn btn-outline-secondary btn-lg" %>
  <%= link_to " マイグループ", user_groups_path(@user), class: "btn btn-primary btn-lg" %>
  <%= link_to "新しいグループを作成", new_user_group_path(@user), class: "btn btn-success btn-lg" %>
</div>